<script>
    // Use CORS proxy to bypass mixed content and CORS issues
    const corsProxy = 'https://cors-anywhere.herokuapp.com/';
    const cameraUrl = 'http://203.147.59.117:31954/ISAPI/Streaming/channels/2/picture';
    const baseUrl = corsProxy + cameraUrl;
    
    const maxImages = 9;
    let imageHistory = [];
    let refreshInterval;
    let isRefreshing = true;

    function addNewImage() {
        const now = new Date();
        const timestamp = now.getTime();
        const timeString = now.toLocaleTimeString();
        
        // Create image URL with timestamp to prevent caching
        const imageUrl = `${baseUrl}?t=${timestamp}`;
        
        // Test if the proxy is working
        const img = new Image();
        img.crossOrigin = "anonymous"; // Enable CORS
        img.onload = function() {
            // Add to history with timestamp
            imageHistory.unshift({
                url: imageUrl,
                time: timeString
            });
            
            if (imageHistory.length > maxImages) {
                imageHistory.pop();
            }

            updateGrid();
            document.getElementById('status').textContent = `Last updated: ${timeString} (${imageHistory.length} images stored)`;
        };
        
        img.onerror = function() {
            document.getElementById('status').textContent = `Error loading image at ${timeString}. Check camera connection.`;
            console.error('Failed to load image:', imageUrl);
        };
        
        img.src = imageUrl;
    }

    function updateGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        imageHistory.forEach((imageData, index) => {
            const container = document.createElement('div');
            container.className = 'image-container';
            
            const img = document.createElement('img');
            img.src = imageData.url;
            img.alt = `CCTV Image ${index + 1}`;
            img.crossOrigin = "anonymous";
            
            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = imageData.time;
            
            container.appendChild(img);
            container.appendChild(timestamp);
            grid.appendChild(container);
        });
    }

    function toggleRefresh() {
        if (isRefreshing) {
            clearInterval(refreshInterval);
            document.getElementById('refresh-status').textContent = 'Auto-refresh: OFF';
            isRefreshing = false;
        } else {
            startRefresh();
            document.getElementById('refresh-status').textContent = 'Auto-refresh: ON (every 30s)';
            isRefreshing = true;
        }
    }

    function clearImages() {
        imageHistory = [];
        updateGrid();
        document.getElementById('status').textContent = 'Images cleared. Next refresh will start new sequence.';
    }

    function startRefresh() {
        refreshInterval = setInterval(addNewImage, 30000); // 30 seconds
    }

    // Initial load
    addNewImage();
    startRefresh();
</script>
