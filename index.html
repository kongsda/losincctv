<script>
    // CORRECT: Use HTTPS (not HTTP) as in your original URL
    const username = 'admin';
    const password = 'NHDlosin23';
    const cameraIP = '203.147.59.117:31954';
    const cameraPath = '/ISAPI/Streaming/channels/2/picture';
    
    // Method 1: Direct HTTPS URL with authentication
    const baseUrl = `https://${username}:${password}@${cameraIP}${cameraPath}`;
    
    const maxImages = 9;
    let imageHistory = [];
    let refreshInterval;
    let isRefreshing = true;

    function addNewImage() {
        const now = new Date();
        const timestamp = now.getTime();
        const timeString = now.toLocaleTimeString();
        
        const imageUrl = `${baseUrl}?t=${timestamp}`;
        
        // Add to history
        imageHistory.unshift({
            url: imageUrl,
            time: timeString
        });
        
        if (imageHistory.length > maxImages) {
            imageHistory.pop();
        }

        updateGrid();
        document.getElementById('status').textContent = `Last updated: ${timeString} (${imageHistory.length} images stored)`;
    }

    function updateGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        imageHistory.forEach((imageData, index) => {
            const container = document.createElement('div');
            container.className = 'image-container';
            
            const img = document.createElement('img');
            img.src = imageData.url;
            img.alt = `CCTV Image ${index + 1}`;
            
            img.onload = function() {
                console.log('Successfully loaded image:', imageData.time);
            };
            
            img.onerror = function() {
                console.error('Failed to load image:', imageData.time);
                this.style.display = 'none';
            };
            
            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = imageData.time;
            
            container.appendChild(img);
            container.appendChild(timestamp);
            grid.appendChild(container);
        });
    }

    function toggleRefresh() {
        if (isRefreshing) {
            clearInterval(refreshInterval);
            document.getElementById('refresh-status').textContent = 'Auto-refresh: OFF';
            isRefreshing = false;
        } else {
            startRefresh();
            document.getElementById('refresh-status').textContent = 'Auto-refresh: ON (every 30s)';
            isRefreshing = true;
        }
    }

    function clearImages() {
        imageHistory = [];
        updateGrid();
        document.getElementById('status').textContent = 'Images cleared. Next refresh will start new sequence.';
    }

    function startRefresh() {
        refreshInterval = setInterval(addNewImage, 30000);
    }

    // Initial load
    addNewImage();
    startRefresh();
</script>
