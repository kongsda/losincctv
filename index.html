<script>
    const username = 'admin';
    const password = 'NHDlosin23';
    const cameraIP = '203.147.59.117:31954';
    const cameraPath = '/ISAPI/Streaming/channels/2/picture';
    const originalUrl = `https://${username}:${password}@${cameraIP}${cameraPath}`;
    
    // Try these working CORS proxies one by one
    const corsProxies = [
        'https://api.allorigins.win/raw?url=',           // Option 1 [web:149][web:152]
        'https://corsproxy.io/?',                       // Option 2 [web:149][web:152] 
        'https://cors.sh/',                             // Option 3 [web:152]
        'https://proxy.cors.sh/',                       // Option 4 [web:152]
        'https://cors-anywhere.herokuapp.com/'          // Option 5 (often doesn't work)
    ];
    
    // Start with the first proxy
    let currentProxyIndex = 0;
    const baseUrl = corsProxies[currentProxyIndex] + originalUrl;
    
    const maxImages = 9;
    let imageHistory = [];
    let refreshInterval;
    let isRefreshing = true;

    function addNewImage() {
        const now = new Date();
        const timestamp = now.getTime();
        const timeString = now.toLocaleTimeString();
        
        const imageUrl = `${baseUrl}&t=${timestamp}`;
        
        // Test with fetch first to see detailed errors
        fetch(imageUrl)
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.blob();
            })
            .then(blob => {
                const imageUrl = URL.createObjectURL(blob);
                
                imageHistory.unshift({
                    url: imageUrl,
                    time: timeString
                });
                
                if (imageHistory.length > maxImages) {
                    // Clean up old blob URLs
                    if (imageHistory[maxImages].url.startsWith('blob:')) {
                        URL.revokeObjectURL(imageHistory[maxImages].url);
                    }
                    imageHistory.pop();
                }
                
                updateGrid();
                document.getElementById('status').textContent = `‚úÖ Last updated: ${timeString} (${imageHistory.length} images stored)`;
            })
            .catch(error => {
                console.error('Fetch error:', error);
                document.getElementById('status').textContent = `‚ùå Error: ${error.message} at ${timeString}`;
                
                // Try next proxy if current one fails
                tryNextProxy();
            });
    }
    
    function tryNextProxy() {
        currentProxyIndex++;
        if (currentProxyIndex < corsProxies.length) {
            const newProxy = corsProxies[currentProxyIndex];
            console.log('Trying proxy:', newProxy);
            baseUrl = newProxy + originalUrl;
            document.getElementById('status').textContent = `üîÑ Trying alternative proxy ${currentProxyIndex + 1}/${corsProxies.length}...`;
            
            // Try again with new proxy
            setTimeout(addNewImage, 2000);
        } else {
            document.getElementById('status').textContent = `‚ùå All CORS proxies failed. Try manual browser fix below.`;
            showManualFix();
        }
    }
    
    function showManualFix() {
        const statusDiv = document.getElementById('status');
        statusDiv.innerHTML = `
            <div style="background: #ffe6e6; padding: 15px; border-radius: 5px; margin: 20px 0;">
                <strong>All CORS proxies failed. Try this manual fix:</strong><br>
                1. <a href="${originalUrl}" target="_blank">Click here to test camera URL directly</a><br>
                2. If images load above ‚Üë, the issue is CORS. Try these browser fixes:<br>
                ‚Ä¢ <strong>Chrome:</strong> Install "CORS Unblock" extension [web:141][web:146]<br>
                ‚Ä¢ <strong>Firefox:</strong> Install "CORS Everywhere" extension<br>
                ‚Ä¢ Or use direct method below (no CORS proxy)
            </div>
        `;
    }

    function updateGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        
        imageHistory.forEach((imageData, index) => {
            const container = document.createElement('div');
            container.className = 'image-container';
            
            const img = document.createElement('img');
            img.src = imageData.url;
            img.alt = `CCTV Image ${index + 1}`;
            
            const timestamp = document.createElement('div');
            timestamp.className = 'timestamp';
            timestamp.textContent = imageData.time;
            
            container.appendChild(img);
            container.appendChild(timestamp);
            grid.appendChild(container);
        });
    }

    function toggleRefresh() {
        if (isRefreshing) {
            clearInterval(refreshInterval);
            document.getElementById('refresh-status').textContent = 'Auto-refresh: OFF';
            isRefreshing = false;
        } else {
            startRefresh();
            document.getElementById('refresh-status').textContent = 'Auto-refresh: ON (every 30s)';
            isRefreshing = true;
        }
    }

    function clearImages() {
        // Clean up blob URLs
        imageHistory.forEach(item => {
            if (item.url.startsWith('blob:')) {
                URL.revokeObjectURL(item.url);
            }
        });
        imageHistory = [];
        updateGrid();
        document.getElementById('status').textContent = 'Images cleared. Next refresh will start new sequence.';
    }

    function startRefresh() {
        refreshInterval = setInterval(addNewImage, 30000);
    }

    // Initial load
    addNewImage();
    startRefresh();
</script>
